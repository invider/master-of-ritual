<html>
    <head><title>Life</title></head>
    <script src="/jam/fix.js"></script>
    <body>
        <script>
        "use strict"

        /*
        * Following script demonstrates how to setup jam tree
        * with global declarations 
        */

        // declare field entity
        var field = {
            info: 'life field',
            paused: false,

            Z: 0,

            EVO: 1,
            SIZE: 7,

            step: 0,
            field: [],
            width: 250,
            height: 50,

            get: function(x, y) {
                if (x < 0 || x >= this.width || y < 0 || y >= this.height) return 0
                return this.field[y * this.width + x]
            },
            isAlive: function(x, y) {
                let v = this.get(x, y)
                if (v && v !== true && v !== 0) return true
                return false
            },
            set: function(x, y, v) {
                if (x < 0 || x >= this.width || y < 0 || y >= this.height) return
                this.field[y * this.width + x] = v
            },
            update: function(x, y) {
                if (!this.get(x, y)) {
                    this.set(x, y, 1)
                } else {
                    this.set(x, y, this.get(x, y) + 1)
                }
            },
            kill: function(x, y) {
                this.set(x, y, -1)
            },
            shift: function(x, y) {
                let v = this.get(x, y)
                if (v === true) this.set(x, y, 1)
                else if (v < 0) this.set(x, y, 0)
            },
            neighbours: function(x, y) {
                let i = 0
                if (this.isAlive(x-1, y-1)) i++
                if (this.isAlive(x-1, y)) i++
                if (this.isAlive(x-1, y+1)) i++
                if (this.isAlive(x, y-1)) i++
                if (this.isAlive(x, y+1)) i++
                if (this.isAlive(x+1, y-1)) i++
                if (this.isAlive(x+1, y)) i++
                if (this.isAlive(x+1, y+1)) i++
                return i
            },

            fill: function(x, y, list) {
                let t = this
                list.forEach( function(e) {
                    t.update(e[0]+x, e[1]+y)
                })
            },
            

            evo: function(delta) {
                if (this.paused) return
                this.step += delta
                if (this.step > this.EVO) {
                    this.step -= this.EVO

                    // evolve
                    for (let x = 0; x < this.width; x++) {
                        for (let y = 0; y < this.height; y++) {
                            let n = this.neighbours(x, y)
                            if (this.isAlive(x, y)) {
                                if (n < 2 || n > 3) {
                                    this.kill(x, y)
                                } else {
                                    this.update(x, y)
                                }
                            } else {
                                if (n === 3) {
                                    this.set(x, y, true)
                                }
                            }
                        }
                    }

                    for (let x = 0; x < this.width; x++) {
                        for (let y = 0; y < this.height; y++) {
                            this.shift(x, y)
                        }
                    }
                }
            },

            draw: function() {
                let ctx = this._.ctx

                // draw background
                ctx.fillStyle = "#220044"
                ctx.fillRect(0, 0, this._.env.width, this._.env.height)

                // draw cells
                for (let y = 0; y < this.height; y++) {
                    for (let x = 0; x < this.width; x++) {
                        let cell = this.get(x, y)
                        if (cell && cell > 0) {
                            ctx.fillStyle="#FF0040";
                            ctx.fillRect(x * this.SIZE, y * this.SIZE, this.SIZE, this.SIZE); 
                        }
                    }
                }
            }
        }
        this['@lab/field'] = field

        this['@setup'] = function() {
            this._.log.out('setting up the field...')
            field.width = Math.floor(this._.ctx.width/field.SIZE)
            field.height = Math.floor(this._.ctx.height/field.SIZE)
            field.fill(20, 10, [
                [1, 2],
                [2, 1],
                [2, 2],
                [2, 3],
                [3, 2],
                ])

            field.fill(30, 20, [
                [2, 1],
                [2, 2],
                [2, 3],
                ])
        }

        this['@trap/click'] = function(e) {
            let tx = Math.floor(e.x/field.SIZE)
            let ty = Math.floor(e.y/field.SIZE)
            if (field.isAlive(tx, ty)) {
            //  field.kill(tx, ty)
            } else {
                field.set(tx, ty, 1)
            }
        }

        // pause
        this['@trap/spaceUp'] = function(e) {
            field.paused = !field.paused
        }

        // slow down
        this['@trap/arrowleftUp'] = function(e) {
            field.EVO *= 1.2
        }

        // speed up
        this['@trap/arrowrightUp'] = function(e) {
            field.EVO *= 0.8
        }

        </script>
    </body>
</html>
